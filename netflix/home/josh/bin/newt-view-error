#!/bin/bash

declare -a names
declare -a files
declare -i index

if [[ "$1" =~ ^[0-9]+$ ]]; then
    index=$1
    shift
fi

count=10
pattern="$@"

function view_file () {
    file="$1"
    pager=${PAGER:-less -R}
    echo ">>> $file"
    exec $pager "$file"
}

while read -r f; do
    ts="$(sed -n 1p "$f" | cut -d\  -f2-)"
    cmd="$(sed -n 2p "$f" | cut -d\  -f3-)"
    if [[ "$cmd" == *--help-man ]] || [[ "$cmd" != *"$pattern"* ]]; then
        continue
    fi
    files+=("$f")
    names+=("$(printf "%s\t\e[1m%s\e[0m" "$ts" "$cmd")")
done < <(find $HOME/.newt-cache/run-logs -maxdepth 2 -type f -name debug.log | sort -r)

if [[ -n "$index" ]]; then
    view_file "${files[$index]}"
elif [[ "$count" == "1" ]]; then
    view_file "${files[0]}"
fi

min=0
PS3="selection: (1-$count,more,quit) "
while true; do select cmd in "${names[@]:min:count}"; do
    case $REPLY in
        Q*|q*) exit ;;
        M*|m*|"") ;;
        *)
            if [[ "$REPLY" -lt 1 || "$REPLY" -gt "$count" ]]; then
                echo "invalid response"
                continue 2
            fi
            n=$((min+REPLY-1))
            view_file "${files[n]}"
            ;;
    esac
    echo ">>> more"
    min=$((min+count))
    continue 2
done; done
